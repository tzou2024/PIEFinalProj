#include <SpeedyStepper.h>
#include <stdlib.h>     /* atoi */

const char picture[] PROGMEM = {"1111111111111111111111111110001111100011111111111001000001001111111111110011011101111111111111100111101111111111111111011100111111111111111011111011111111111111001111110111111111011001111111001111111100001111111110110011111011111111111100001111100111111111111101111111011111111111101111111101111111111100111111110111111111110111111111000000000001011111111110111111111001111111111001111001101111111111110011111100111111111111100111101111111111111111000001111111111111111111111111111111"};

char myChar;
//String picture = "1111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100111111111111111111111111111111111111111111111110011111111111111111111111111111111111111111111111100000001111111111111111111111111111111111111110000000111111111111111111111111111111111111111111111110000000000111111111111111111111111111111110000000000011111111111111111111111111111111111111111111111100000000000011111111111111111111111111000000000000011111111111111111111111111111111111111111111111110000000000000001111111111111111111110000000000000001111111111111111111111111111111111111111111111111100000110000000000111111111111111000000000011000001111111111111111111111111111111111111111111111111110000011111000000000111111111110000000001111100000111111111111111111111111111111111111111111111111111100000111111000000000111111100000000111111100000111111111111111111111111111111111111111111111111111111000001111111100000000111000000001111111100000111111111111111111111111111111111111111111111111111111100000011111111100000000000000011111111110000011111111111111111111111111111111111111111111111111111111000001111111111100000000000111111111110000011111111111111111111111111111111111111111111111111111111110000011111111111100000001111111111110000011111111111111111111111111111111111111111111111111111111111100000111111111111000001111111111110000001111111111111111111111111111111111111111111111111111111111110000001111111111111111111111111110000001111111111111111111111111111111111111111111111111111111111111100000011111111111111111111111110000001111111111111111111111111111111111111111111111111111111111111111000000111111111111111111111110000001111111111111111111111111111111111111111111111111111111111111111110000001111111111111111111110000001111111111111111111111111111111111111111111111111111111111111111111100000011111111111111111110000001111111111111111111111111111111111111111111111111111111111111111111111000000111111111111111110000001111111111111111111111111111111111111111111111111111111111111111111111110000000111111111111100000001111111111111111111111111111111111111111111111111111111111111111111111111110000001111111111100000001111111111111111111111111111111111111111111111111111111111111111111111111111000000111111111110000001111111111111111111111111111111111111111111111111111111111111111111111111111000000111111111111100000011111111111111111111111111111111111111111111111111111111111111111111111111000000111111111111111000000111111111111111111111111111111111111111111111111111111111111111111111111000000111111111111111110000001111111111111111111111111111111111111111111111111111111111111111111111000000111111111111111111100000011111111111111111111111111111111111111111111111111111111111111111111000000111111111111111111111000001111111111111111111111111111111111111111111111111111111111111111111000000111111111111111111111110000011111111111111111111111111111111111111111111111111111111111111111000000111111111111111111111111100000111111111111111111111111111111111111111111111111111111111111111100000111111111111111111111111111000001111111111111111111111111111111111111111111111111111111111111100000111111111111111111111111111100000011111111111111111111111111111111111111111111111111111111111100000111111111111111111111111111111000000111111111111111111111111111111111111111111111111111111111100000011111111111111111111111111111110000011111111111111111111111111111111111111111111111111111111110000011111111111111111111111111111111100000111111111111111111111111111111111111111111111111111111110000011111111111111111111111111111111110000001111111111111111111111111111111111111000111111111111110000011111111111111111111111111111111111100000111111111111111111111111111111111111000000000011111111000001111111111111111111111111111111111111000001111111111111111111111111111111111100000000000000111000001111111111111111111111111111111111111100000111111111111111111111111111111111110000000000000000000000111111111111111111111111111111111111111000001111111111111111111111111111111111100000110000000000000111111111111111111111111111111111111111110000011111111111111110111111111111111111000001111110000000011111111111111111111111111111111111111111000001111111111000000001111111111111111100000011111111000011111111111111111111111111111111111111111110000011110000000000000011111111111111111000001111111111111111111111111111111111111111111111111111111000000000000000000000011111111111111111110000011111111111111111111111111111111111111111111111111111110000000000000010000011111111111111111111100000111111111111111111111111111111111111111111111111111111000000000111111000001111111111111111111111000001111111111111111111111111111111111111111111111111111110000111111111000001111111111111111111111100000011111111111111111111111111111111111111111111111111111111111111111000001111111111111111111111111000000111111111111111111111111111111111111111111111111111111111111111000001111111111111111111111111110000001111111111111111111111111111111111111111111111111111111111111000000111111111111111111111111111100000011111111111111111111111111111111111111111111111111111111111100000111111111111111111111111111111000000111111111111111111111111111111111111111111111111111111111100000111111111111111111111111111111110000011111111111111111111111111111111111111111111111111111111100000111111111111111111111111111111111100001111111111111111111111111111111111111111111111111111111100000111111111111111111111111111111111100000111111111111111111111111111111111111111111111111111111100000111111111111111111111111111111111110000011111111111111111111111111111111111111111111111111111100000111111111111111111111111111111111111000001111111111111111111111111111111111111111111111111111000000111111111111111111111111111111111111100000111111111111111111111111111111111111111111111111111100000111111111111111111111111111111111111110000011111111111111111111111111111111111111111111111111100000111111111111111111111111111111111111111000001111111111111111111111111111111111111111111111111110000011111111111111111111111111111111111111100000111111111111111111111111111111111111111111111111111000001111111111111111111111111111111111111110000011111111111111111111111111111111111111111111111111100000111111111111111111111111111111111111111000001111111111111111111111111111111111111111111111111110000011111111111111111111111111111111111111100000111111111111111111111111111111111111111111111111111000001111111111111111111111111111111111111110000011111111111111111111111111111111111111111111111111100000111111111111111111111111111111111111111100001111111111111111111111100000111111111111111111111110000011111111111111111111111111111111111111110000011111111111100000000000000000000000001111111111111000011111111111111111111111111111111111111111000001111111100000000000000000000000000000000011111111000001111111111111111111111111111111111111111100000111110000000000000000000000000000000000000001111100000111111111111111111111111111111111111111111000001000000000000111111111111111111111000000000000110000011111111111111111111111111111111111111111100000000000001111111111111111111111111111111000000000000011111111111111111111111111111111111111111110000000000111111111111111111111111111111111111100000000001111111111111111111111111111111111111111111100000001111111111111111111111111111111111111111100000001111111111111111111111111111111111111111111110000011111111111111111111111111111111111111111111100000111111111111111111111111111111111111111111111100000111111111111111111111111111111111111111111100000111111111111111111111111111111111111111111111111000001111111111111111111111111111111111111111110000011111111111111111111111111111111111111111111111100000111111111111111111111100000011111111111110000011111111111111111111111111111111111111111111111111000001111111111111111111100000000111111111110000001111111111111111111111111111111111111111111111111110000011111111111111111100000000001111111111000001111111111111111111111111111111111111111111111111111000000111111111111111111000000001111111111000001111111111111111111111111111111111111111111111111111110000001111111111111111110000001111111111000001111111111111111111111111111111111111111111111111111111100000011111111111111111110011111111111000001111111111111111111111111111111111111111111111111111111111000000111111111111111111111111111111000000111111111111111111111111111111111111111111111111111111111110000001111111111111111111111111111000000111111111111111111111111111111111111111111111111111111111111100000011111111111111111111111111000001111111111111111111111111111111111111111111111111111111111111111000000111111111111111111111110000001111111111111111111111111111111111111111111111111111111111111111110000000111111111111111111110000001111111111111111111111111111111111111111111111111111111111111111111110000001111111111111111100000001111111111111111111111111111111111111111111111111111111111111111111111100000001111111111111100000011111111111111111111111111111111111111111111111111111111111111111111111111100000001111111111000000011111111111111111111111111111111111111111111111111111111111111111111111111111000000001111110000000111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000000001111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000000011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000000111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111"

int imgheight = 22;

//
// pin assignments
//
const int LED_PIN = 13;
const int MOTOR_X_STEP_PIN = 2;
const int MOTOR_Y_STEP_PIN = 3;
const int MOTOR_Z_STEP_PIN = 4;
const int MOTOR_X_DIR_PIN = 5;
const int MOTOR_Y_DIR_PIN = 6;
const int MOTOR_Z_DIR_PIN = 7;
const int STEPPERS_ENABLE_PIN = 8;
const int LIMIT_SWITCH_X_PIN = 9;
const int LIMIT_SWITCH_Y_PIN = 10;
//const int LIMIT_SWITCH_Z_PIN = 11;
const int SPINDLE_ENABLE_PIN = 12;
const int SPINDLE_DIRECTION_PIN = 13;
int no_color = 90;
int blue_thresh = 28;
int red_thresh = 50;
int blue = blue_thresh + no_color;
int red = no_color - red_thresh;
int pos;
int servopos = 11;
int i = 1;
int shifty = 1;
int shiftx = 1;
#include <Servo.h>
Servo myservo;  // create servo object to control a servo


//
// create the stepper motor objects
//
SpeedyStepper stepperX;
SpeedyStepper stepperY;


void setup() 
{
  Serial.begin(9600); // opens serial port, sets data rate to 9600 bps

  //
  // setup the LED pin and enable print statements
  //
  pinMode(LED_PIN, OUTPUT);   
  pinMode(STEPPERS_ENABLE_PIN, OUTPUT);       // be sure to do this
  Serial.begin(9600);
  myservo.attach(servopos);  // attaches the servo on pin 9 to the servo object

  //
  // connect and configure the stepper motor to there IO pins
  //
  stepperX.connectToPins(MOTOR_X_STEP_PIN, MOTOR_X_DIR_PIN);
  stepperY.connectToPins(MOTOR_Y_STEP_PIN, MOTOR_Y_DIR_PIN);


  //
  // enable the stepper motors
  //
  digitalWrite(STEPPERS_ENABLE_PIN, LOW);     // be sure to do this
  myservo.write(no_color);

  stepperX.setSpeedInStepsPerSecond(600);
  stepperX.setAccelerationInStepsPerSecondPerSecond(30);
  stepperY.setSpeedInStepsPerSecond(600);
  stepperY.setAccelerationInStepsPerSecondPerSecond(1000);
  stepperX.setStepsPerMillimeter(10);
  stepperY.setStepsPerMillimeter(28);

}


void red_dot()
{
  delay(15);
  myservo.write(red);              // tell servo to go to position in variable 'pos'
  delay(100);                       // waits 15ms for the servo to reach the position
  myservo.write(no_color);              // tell servo to go to position in variable 'pos'
  delay(15);                       // waits 15ms for the servo to reach the position
}

void move_up(int y){
   delay(30);
   stepperY.moveRelativeInMillimeters(-4* y);
   delay(50);  
}

void right_shift(int x){
  delay(15);
  stepperX.moveToPositionInMillimeters(-4 * x);
  delay(15);
}


void loop() {
  // put your main code here, to run repeatedly:
  for (long i = 1; i <= strlen_P(picture); i++){

    myChar = pgm_read_byte_near(picture + (i-1));
    Serial.println(i);
    if (myChar == '1'){
      red_dot();
      move_up(1);
      shifty ++;
      }


      
    else {
      move_up(1);
      shifty ++;
    }


    
    if (i % imgheight == 0){
         stepperY.moveToPositionInSteps(0);
         stepperX.moveRelativeInMillimeters(-4);     
    }
    
    
    }
    stepperX.moveToPositionInSteps(0);
    delay(50);
    stepperY.moveToPositionInSteps(0);   
    delay(50);
    while(1){}
    }
    
 
